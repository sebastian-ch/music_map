<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>VA Piano Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />

    <script src="script/audiosynth.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>


    <style>
        body {
            margin: 0;
            padding: 0;
            background: whitesmoke;
            font-family: "Noto Sans", sans-serif;
            color: #3d3d3d;
        }
        
        section {
            width: 960px;
            margin: 20px auto;
        }
        
        h1 {
            width: 960px;
            margin: 20px auto;
            font-family: "Lora", serif;
        }
        
        #map {
            width: 80%;
            height: 540px;
            margin: 10px auto 10px auto;
            background: whitesmoke;
            border: 2px solid #dddedf;
        }

    </style>
</head>

<body>

    <h1>finally u can look at a map of virginia AND play the piano</h1>
    <div id='map'></div>
    
    <script>
        
        var piano = Synth.createInstrument('piano');

        var options = {

            zoomControl: false,
            dragging: false,
            scrollWheelZoom: false
        };
        
        var styleOptions = {
            
            color: '#1f78b4',
            fillColor: '#dddddd',
            weight: 1,
            fillOpacity: 1
            
        };

        var map = L.map('map', options);
        
        map.doubleClickZoom.disable(); 

        $.getJSON('va.json', function(counties) {

                Papa.parse('va-piano.csv', {

                    download: true,
                    header: true,
                    complete: function(data) {

                        processData(counties, data);
                    }
                });
            })
            .fail(function() {

                console.log("error!");
            });

        function processData(counties, data) {

            for (var county in counties.features) {
                var props = counties.features[county].properties;

                for (var d in data.data) {

                    if (props.COUNTY == data.data[d].COUNTY) {

                        counties.features[county].properties["key"] = data.data[d].key;
                        counties.features[county].properties["octave"] = data.data[d].octave;
                        break;
                    };
                };
            };
            
            drawMap(counties);
        }

        function drawMap(counties) {

            var dataLayer = L.geoJson(counties, {
                
                style:  styleOptions 
                
            }).addTo(map);

            map.fitBounds(dataLayer.getBounds());
            map.setZoom(map.getZoom());

            dataLayer.eachLayer(function(layer) {

                var props = layer.feature.properties;

                layer.on('mouseover', function() {

                    this.setStyle({
                        color: 'yellow',
                        weight: 2
                    });

                    layer.bringToFront();
                });

                layer.on('mouseout', function() {

                    this.setStyle(styleOptions);
                });

                layer.on('mousedown', function() {
                    
                    playPiano(this);
                });
                
                layer.on('mouseup', function () {
                    
                    this.setStyle(styleOptions); 
                });
            });
        }

        function playPiano(x) {
            
            x.setStyle({
                color: '#1f78b4',
                fillColor: '#000'
            });
            
            x.bringToFront();
            
            var props = x.feature.properties;
            
            piano.play(props['key'], props['octave'], 2);
        }

    </script>
</body>

</html>
